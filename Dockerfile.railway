# Agent Zero Enterprise - Railway Deployment
FROM python:3.11-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    nginx \
    curl \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Copy the full Agent Zero codebase (uploaded via railway up)
COPY . /app/

# Install Python dependencies
# We try requirements.txt first, but if it fails (e.g. due to system dep issues), 
# we fallback to manual install of core packages.
RUN pip install --no-cache-dir -r requirements.txt || \
    pip install --no-cache-dir \
    flask[async] \
    python-socketio \
    flask-basicauth \
    fastapi \
    uvicorn[standard] \
    python-dotenv \
    openai \
    anthropic \
    python-multipart \
    aiofiles \
    websockets \
    pydantic \
    httpx

# Explicitly ensure critical UI and Agent dependencies are installed
# We list them here because requirements.txt can fail on some systems
# CORE OPTIMIZATION: Install CPU-only PyTorch to save ~4GB of space
RUN pip install --no-cache-dir torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu

RUN pip install --no-cache-dir \
    flask[async] \
    python-socketio \
    flask-basicauth \
    nest-asyncio \
    langchain-core \
    langchain-community \
    duckduckgo-search \
    beautifulsoup4 \
    html2text \
    playwright \
    webdriver-manager \
    markdown \
    pypdf \
    sentence-transformers \
    unstructured-client \
    lxml_html_clean \
    newspaper3k \
    paramiko && \
    rm -rf /root/.cache/pip

# Install playwright for browser agent
RUN playwright install chromium 2>/dev/null && \
    rm -rf /var/lib/apt/lists/* && \
    rm -rf /root/.cache/ms-playwright/chromium-*/chrome-linux/chrome_sandbox

# Set up Nginx config
COPY nginx.conf /etc/nginx/nginx.conf

# Set up directories and permissions
RUN mkdir -p /app/data /app/logs /var/log/nginx && \
    chmod +x /app/start.sh

# Environment defaults
ENV PYTHONUNBUFFERED=1
ENV PORT=80
ENV API_PORT=50001
ENV PYTHONPATH=/app

EXPOSE 80

CMD ["/bin/bash", "/app/start.sh"]
